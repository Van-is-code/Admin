<?php 

include_once dirname(__FILE__) . '../../auth/auth.php';
require_once "../view/navbar.php";
require_once "../config/database.php";

if($_SERVER["REQUEST_METHOD"] == "POST") {
  $id = $_POST["product_id"];
  $name = $_POST['name'];
  $price = $_POST['price'];
  $desc = $_POST['description'];
  $category_id = $_POST['category_id'];

  // INSERT INTO DB without image first
  date_default_timezone_set('Asia/Ho_Chi_Minh');
  $timeUpdate = date('Y-m-d H:i:s');
  $sqlInsert = "INSERT INTO `products` (`product_id`, `product_name`, `prd_price`, `prd_description`, `category_id`, `time_update`) "
             . "VALUES ('$id', '$name', '$price', '$desc', '$category_id', '$timeUpdate');";
  
  if ($conn->query($sqlInsert) === TRUE) {
    echo "<div class='alert alert-success'>Product data saved successfully.</div>";
    // If the product data is inserted successfully, proceed to upload the image
    if(isset($_FILES["image"])) {
      $targetDir = "../upload/products/";
      $targetFile = $targetDir . basename($_FILES["image"]["name"]);
      $imageFileType = strtolower(pathinfo($targetFile,PATHINFO_EXTENSION));
      $newFileName = uniqid() . '.' . $imageFileType;
      $targetPath = $targetDir . $newFileName;
    
      if (move_uploaded_file($_FILES["image"]["tmp_name"], $targetPath)) {
        // Update the product record with the image name
        $sqlUpdate = "UPDATE `products` SET `prd_image` = '$newFileName' WHERE `product_id` = '$id';";
        if ($conn->query($sqlUpdate) === TRUE) {
          echo "<div class='alert alert-success'>Image uploaded and saved successfully.</div>";
        } else {
          echo "<div class='alert alert-danger'>Failed to update product with image.</div>";
        }
      } else {
        echo "<div class='alert alert-danger'>Sorry, there was an error uploading your file.</div>";
      }
    }
  } else {
    echo "<div class='alert alert-danger'>Failed to save product data.</div>";
  }
  
  $conn->close();
}
?>



<!-- <div class="mb-3">
        <label for="formGroupExampleInput2" class="form-label">Category:</label>
        <input type="text" class="form-control" list="category" name="category_id"> 
        <datalist id="category" >
          <?php 
          require_once "../config/database.php"; // Include the database connection file
          $sql = "SELECT * FROM category";
          $result = $conn->query($sql);
          if ($result->num_rows > 0) {
        while($row = $result->fetch_assoc()) {
          echo "<option value=".$row['category_id'].">" .$row['category']."</option>";
        }
          }
          $conn->close();
          ?>
        </datalist>
      </div> -->